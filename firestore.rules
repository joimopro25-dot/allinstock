rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if user is super admin
    function isSuperAdmin() {
      return request.auth != null &&
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super_admin';
    }

    // Helper function to check if user belongs to company
    function belongsToCompany(companyId) {
      return request.auth != null &&
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId == companyId;
    }

    // Users collection - users can access their own document or super admin can access all
    match /users/{userId} {
      allow read: if request.auth != null && (request.auth.uid == userId || isSuperAdmin());
      allow write: if request.auth != null && request.auth.uid == userId;
      allow create: if request.auth != null;
      allow update, delete: if isSuperAdmin();
    }

    // Companies collection - super admin can access all, users can only access their company
    match /companies/{companyId} {
      allow read: if request.auth != null && (belongsToCompany(companyId) || isSuperAdmin());
      allow write: if request.auth != null && (belongsToCompany(companyId) || isSuperAdmin());
      allow create: if request.auth != null;

      // Products and nested subcollections
      match /products/{productId} {
        allow read, write: if request.auth != null;

        // Stock locations under products
        match /stockLocations/{locationId} {
          allow read, write: if request.auth != null;
        }

        // Stock movements under products
        match /stockMovements/{movementId} {
          allow read, write: if request.auth != null;
        }
      }

      // Clients
      match /clients/{clientId} {
        allow read, write: if request.auth != null;
      }

      // Suppliers
      match /suppliers/{supplierId} {
        allow read, write: if request.auth != null;
      }

      // Quotations
      match /quotations/{quotationId} {
        allow read, write: if request.auth != null;
      }

      // Invoices
      match /invoices/{invoiceId} {
        allow read, write: if request.auth != null;
      }

      // Purchase Orders
      match /purchaseOrders/{purchaseOrderId} {
        allow read, write: if request.auth != null;
      }

      // Product Families
      match /productFamilies/{familyId} {
        allow read, write: if request.auth != null;
      }

      // Product Types
      match /productTypes/{typeId} {
        allow read, write: if request.auth != null;
      }

      // Product Categories
      match /productCategories/{categoryId} {
        allow read, write: if request.auth != null;
      }

      // Email Configuration
      match /emailConfig/{configId} {
        allow read, write: if request.auth != null;
      }

      // Emails
      match /emails/{emailId} {
        allow read, write: if request.auth != null;
      }

      // Calendar Configuration
      match /calendarConfig/{configId} {
        allow read, write: if request.auth != null;
      }

      // Calendar Events
      match /calendarEvents/{eventId} {
        allow read, write: if request.auth != null;
      }

      // Stock Locations (warehouses, vans, offices)
      match /stockLocations/{locationId} {
        allow read, write: if request.auth != null;
      }
    }

    // Super Admin Only Collections
    // Promo Codes - only super admin can manage
    match /promoCodes/{promoCodeId} {
      allow read: if request.auth != null; // Anyone can read to validate promo codes
      allow write, create, update, delete: if isSuperAdmin();
    }

    // System Analytics - only super admin can access
    match /analytics/{docId} {
      allow read, write: if isSuperAdmin();
    }

    // System Settings - only super admin can modify
    match /settings/{settingId} {
      allow read: if request.auth != null;
      allow write: if isSuperAdmin();
    }

    // Plans collection - super admin can manage, anyone can read
    match /plans/{planId} {
      allow read: if request.auth != null;
      allow write, create, update, delete: if isSuperAdmin();
    }

    // Payments collection - only super admin can access
    match /payments/{paymentId} {
      allow read, write: if isSuperAdmin();
    }
  }
}
